#!/usr/bin/env bash

crunchNamespace=/run/user/1000/plan9/srv
localPlan9Services=( snarf )
remotePlan9Services=( plumb )

extraArgs=()
for svc in "${localPlan9Services[@]}"; do
    ssh crunch.eraserhead.net rm -f "${crunchNamespace}/${svc}"
    extraArgs+=( "-R${crunchNamespace}/${svc}:${NAMESPACE}/${svc}" )
done
for svc in "${remotePlan9Services[@]}"; do
    rm -f "${NAMESPACE}/${svc}"
    extraArgs+=( "-L${NAMESPACE}/${svc}:${crunchNamespace}/${svc}" )
done

autossh -M 0 -f \
    -o 'ServerAliveInterval 30' \
    -o 'ServerAliveCountMax 3' \
    -o 'ExitOnForwardFailure yes' \
    -L8080:localhost:8080 \
    -L3447:localhost:3447 \
    "${extraArgs[@]}" \
    -T -N crunch.eraserhead.net
