#!/bin/bash

set -xeo pipefail

project_directory() {
    local project="$1" cdpath_dirs cdpath
    IFS=: read -ra cdpath_dirs <<< "$CDPATH"
    for cdpath in "${cdpath_dirs[@]}"; do
        if [[ -d "$cdpath/$project" ]]; then
            printf '%s/%s\n' "$cdpath" "$project"
            return 0
        fi 
    done 
    return 1
}

project_todo() {
    printf '%s\n' ~/src/data/"$1"-todo.md
}

project="$1"
if [[ -z "$project" ]]; then
    printf 'proj: need a project name.\n' >&2
    exit 1
fi

if ! tmux select-window -t "$project" 2>/dev/null; then
    kak -s "$project" -d >/dev/null 2>&1

    if ! tmux list-sessions -F '#S' |grep -q '^local$'; then
        tmux new-session -d -c"$(project_directory "$project")" -s local -n"$project" -x490 -y86 kak -c "$project"
    else
        tmux new-window -c"$(project_directory "$project")" -n"$project" kak -c "$project"
    fi

    tmux split-pane -h -c"$(project_directory "$project")" bash -l

    todo="$(project_todo "$project")"
    if [[ ! -f $todo ]]; then printf '# TODO\n\n' >"$todo"; fi
    tmux split-pane -b -v -c"$(project_directory "$project")" -l15 kak -c "$project" "$todo"
fi

activate Alacritty
